# 仔细打磨写过的程序

从去年12月到最近，把公司内的AppWiki网站还有这个博客网站的代码，重新进行了调整，颇多感触。

比如代码中早期很多地方因为求快都是HardCode，最典型的比如AppWiki的更新日期居然都是每天手动修改PHP，直到昨天才忽然想到可以利用stat函数取出数据库文件的mtime来自动更新，把依赖降到数据库文件本身。同样如博客的首页，原来是手写的2016、2017年，过了一年还要手动创建目录，改成每页固定显示10篇，用下部的页号签来自动导引。凡此种种都是让整个网站环环相扣，互相关联，自然就能有牵一发而动全身。

还有就是AppWiki的解析代码，因为发现Win7的cmd用chcp65001转成UTF-8的显示效果比XP好了很多，就切过来了。但是原来的代码由于用ls来判断文件是否被更新，就依赖于终端的编码环境，造成移植的困难，加之需要批处理、VBScript和Lua三种语言共同使用，在Windows下速度慢不说，还屡次因不熟悉VBScript而苦恼，后来发现核心的VBS就三行代码，用luacom实现也不难，中途还顺手编译了luaiconv解决GBK到UTF-8的问题。整个切换完用一种语言实现，不仅速度快了，代码文件和中间文件也变少了。(因为不同语言只能靠中间文件来交互，导致目录下非常凌乱而难看)

新的段落式解析代码，也一直有bug，多个文件只能解析第一个文件，当时不愿意解决，就用批处理的方式分次处理，后来为了提高自动化程度，把批处理也改用Lua来实现，就必须解决这个bug，直到早上通过打印才发现原来是解析完第一个文件后，协程状态就变成dead了。原因是协程代码在结束时用了return，必然会导致dead。这是我第一次用协程，对语义不熟悉造成的。一个dead的协程无法resume，而我整个程序始终用这个协程变量处理文件，所以超过一个文件就失败了。找到这个问题后，顺带发现原来的协程变量还是全局的，坏味道。把协程变量的范围缩小到函数内，并增加了协程状态判断，
保证每个新的文件解析开始创建一个新协程，解决问题。然后也按照三代协议解析代码重构的思路，用lua实现了比较文件时间，生成HTML和SQL并写数据库等配套环节。重构后的流程非常清晰，增加一份文档只要三步：

1. 在man.old里添加源Word名称、更新时间和输出HTML名(这里必须用GBK，没办法)
2. 在解析代码增加一个入口，并确定文件的归类(我用了生物学上的Tribe)和层级，这个环节必须要人工干预
3. SQL脚本里加一项.read xxx.sql

三个步骤分别对应Word->HTML->SQL->DB，任何人接手都能很简单地增加文档了。3月份的时候又做了一次合并，把1和2的内容都记入man.old，再通过中间得到的差分结果来生成SQL脚本，因此需要个性的就只有一个文件，是目前能想到的极限了。

写代码是个不断打磨自己思路的过程，让流程更自然，环节更严密。