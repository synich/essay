# 接口设计的原则与反思

先说说VideoEncode类的感想，
目前的Encode类的构造函数，需要传入一个视频通道号和编码类型，然后返回一个对象。现阶段遇到有个需求，需要解码后的YUV数据经过智能分析，对分析结果的区域进行局部抠图。这时也需要编码资源，但这个编码器似乎又和视频通道并不强关联，再多的还是和解码器的输出有关，这时原先的假设就不再适用了，需要定义新的构造函数才能使用。

再说两个接口的反思

在MCU头文件增加了一种读数据的枚举值。看起来小得不能再小的改动，但还是发现了问题。

原来的头文件中有两个类似接口，分别是recv和recvData，接口注释分别是阻塞等待事件和读取数据，但是看阻塞等待事件的接口，返回的数据结构似乎也能表示数据，为什么偏偏要加在recvData，这两个接口的差异在哪里？

细问之下才知道原来recv的内部实现是把代表MCU的fd加到select的读和异常集合，且超时时间为无限，recvData只是个读数据的接口，不会阻塞。看了实现才明白原来是用recv来等待数据到来，结束后调用recvData。说实话这样的命名方式实在太糟糕，加上接口注释又不清晰，导致这次新增的枚举在recvData中又增加了select操作，原来是上层没有调用recv。这种改动虽然不影响原有逻辑，但从整体功能上造成了recvData的含义不同，阻塞或非阻塞的特性还会随着读取的数据类型而变化，这就很明显地破坏了接口含义的一致性。

再说一个错误的例子，有个createNetBrigde接口，入参有个`const char *name`，从接口看，无非创建一张网桥，然后用name来标识一下，类似创建线程操作，何曾想实现代码中竟然要求name必须是br开头且第3个字符必须是数字，否则不予创建。无论怎么看接口注释，都看不出有这样的限制。而且既然限制必须用br开头，何不把参数定义成uint8，只让调用者传入数字，在实现层构造出br0这样的名字，不仅没有歧义还减少空间。

以前看接口，最多能看出参数是否合适，最近越来越意识到接口的用法、使用前提、使用预期等隐含的语义。

软件工程总是提复用，我的理解复用是有范围的，比如接口恰恰是最不能复用的，一个萝卜一个坑，绝对不能有二意性，且最好功能尽可能单一。只有接口不复用，业务代码才能尽可能地复用。