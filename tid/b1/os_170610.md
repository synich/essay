# dmesg和BSD初期版本的故事

dmesg最早出现在3BSD时代。

1975年Ken Thompson请了一年休假并来到Berkeley担任客座教授，Ken在Berkeley安装了Version 6的Unix，并实现Pascal编译器。这时Bill Joy因为优化这个编译器而出现在历史舞台上。因为其它学校对这个系统也很感兴趣，Joy在77年着手完成系统的拷贝并最终在1978年3月发布了称为1BSD的版本，共卖出30份。接着1979年5月发布了2BSD版本，这个版本有两个程序至今还在用，就是vi和csh，共卖了75份。

头两个版本是Joy初试牛刀，同期发生的重要事件是1978年Berkeley买了VAX机，当时贝尔实验室也为VAX做了适配并命名为UNIX/32V（基于Version 7 Unix）。但这个系统并没有优化好VAX的虚拟内存特性，于是Berkeley的学生大幅重写了内核并把2BSD的程序也移植到了VAX机，最终在1979年底发布了3BSD。从这个版本起，BSD便不再是UNIX的clone了。

dmesg在OpenBSD的实现并不复杂，利用sysctl接口的`CTL_KERN`和`KERN_MSGBUFSIZE`命令字获取信息的长度。再用`KERN_MSGBUF`获取真正的内容。不过这两个枚举在FreeBSD上没有定义，OpenBSD中定义的KERN操作枚举值要比FreeBSD来得多，大概也是两套系统在逐渐演化过程中发生的差异吧。

内核文件是名为bsd的大约10M的文件，不像Linux的vmlinuz文件，bsd就是个普通的ELF执行文件，内核文件不止一个，比如bsd.mp用于多核系统，还有bsd.rd是类似光盘镜像的文件，如果用syspatch升级内核，还会产生一个bsd.syspatch61的备份文件。根目录下还有boot文件，类似于grub，启动顺序也是BIOS->boot->bsd这个顺序。

安装包使用`pkg_xxx`系列，应该是和FreeBSD类似，使用tar包方式，tar包其实有多种格式，GNU的tar用的默认格式是gnu，但OpenBSD用的是ustar，是1988年的posix版本，另外有2001版posix标准的tar，GNU宣称未来也会切换到这种方式。安装包的地址从/etc/installurl获取，目前我只找到清华的repo是
https://ftp.openbsd.org/pub/OpenBSD和https://mirrors.tuna.tsinghua.edu.cn/OpenBSD。

OpenBSD的代码是用cvs管理的，看来落伍但社区觉得已经足够。先说说分支管理：风格很固定，每个版本有`OPENBSD_6_1_BASE`和`OPENBSD_6_1`两个标签(symbolic name)，其中BASE是revision，也就是Milestone，一般是决定开发新版本时，创建一个后续不再更新；而`OPENBSD_6_1`则是基于这个revision的branch，是真正的发行代码。
