# URL转发规则和目录映射

遇到复杂的两级转发，记录理解。环境是容器云网络，外层网关是APISIX，到应用层是nginx代理，最后才到业务的HTTP接口。假设网关给的一级转发规则是`/dcp/`；应用层继续转发`/api/`；业务的页面是`z.html`，接口是`sql.cgi`，开始详述

首先，访问页面不能用根目录，要访问`/dcp/z.html`，这时js的请求一定不能用'/'开头，否则会以根目录来定位，要写成`ajax('GET', 'api/sql.cgi')`。浏览器会根据z.html处在/dcp/目录自动拼接，向`/dcp/api/sql.cgi`发送请求。APISIX收到该请求后，会剥去/dcp头，用/api/sql.cgi向后转发。

接下来配置nginx的转发规则，`location /api/`。千万注意， **一定要加后面的/** 。所有转发服务器在匹配后，都会丢弃匹配部分，把剩下的继续转，但nginx匹配完/api/后，转后业务的是/sql.cgi，会多出一个'/'。这么看还不明显，如果配置成`location /api`，业务收到的请求是`//sql.cgi`，会有两个'/'。如果业务代码能处理连续斜线最好，但是稳妥起见还是用前后都带'/'的匹配规则。

作为对照，algernon的转发则适用`location /api`规则，可见不同的Web实现对转发还是有细微区别。另外nginx能把响应的404等报错也进行回复，但algernon就只能处理200回复。
