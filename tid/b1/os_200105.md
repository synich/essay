# 硬盘操作和文件系统散记

## 硬盘操作

首先要明确个概念，每块硬盘都有设备和分区这层概念，一块硬盘当然对应一个设备，但会有一到多个分区，util-linux包提供了多个操作硬盘的程序。

* fdisk: 应该是最有名的程序了，fdisk -l显示当前总线上已经识别出的设备
* lsblk: 显示块设备、dev的major/minor号、挂载点等。关于lsblk命令查看分区和挂载目录的关系，其实mount也能看，但如果装过容器，mount会看不清楚，这时用lsblk就很方便
* blkid: 只会列出分区，但可以识别文件系统。比如/dev/sda被分成了sda1和sda2，用blkid看不到sda，只能看到sda1和sda2，行为和df命令一样。而lsblk既能看到设备也能看到分区
* hdparm: 只知道，不太会用

以上这些命令都是针对硬盘，所以就算没有挂载，也可以看到硬盘。

file命令的-s选项可以查看块设备的特性，比如`file -s /dev/sda`能看到这块盘是GRUB启动程序，接着又是若干个分区。而直接`file -s /dev/sda1`就只显示分区信息，可见/dev/下面分开显示sda和sda1并不是无意义的。

### 磁盘挂载失败记录

服务器磁盘被拔，导致系统进入emergency模式，即使login所有服务也未启动。原因出在盘被拔，但/etc/fstab却没有修改，系统认为缺少盘所以进了应急模式。每块磁盘会有个UUID，fstab也是通过这个来找盘。用blkid命令可以看到所有盘的UUID。两相对比去掉不存在的盘就行。

修改后不用重启，mount -a就能挂载。这时又出现新问题，报UUID重复错误，用mkfs.xfs -f /dev/sdx格式化硬盘，再挂载就没问题了。

磁盘写入有两种模式

* write through: 直写式，数据不做校验直接写入磁盘，写完后再读出来后写校验值。性能差，可靠性高？
* write back: 写回式，数据先写到cache，再用cache计算校验值，然后数据和校验一起定入磁盘，如果cache足够大且性能强，可以一直写入。有些RAID卡要开启这种模式，除了有cache，还要有电池，保证掉电后cache数据也能写入磁盘。

## 文件系统

安卓有`protect_f`和`protect_s`分区，s是f的备份，专门用来保存SIM ME LOCK数据，运营商专用机就是修改这份数据达到的。原来是保存在/data分区，为保证恢复出厂时不用重新生成，干脆做成独立分区。

文件系统单个分区上限取决于单个簇大小和簇个数，比如ext3的簇个数是uint32，取常见的簇大小4K来算，分区上限就是16TB。（似乎ext3簇大小不可改，NTFS可以改成单簇64K使上限达到256T）

ZFS的默认簇是128K，在和PG数据库配合时，其默认记录大小是8K，如果数据库用于零散查询较多的场景，最好用`zfs set recordsize=8k zp1/data`也调整到8K效率更高。