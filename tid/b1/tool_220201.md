# 压缩技术浅谈

凡涉及存储和传输，就一定会涉及压缩，不同领域的需求和特点也各不同

## 文本

目前我们日常使用的各种压缩软件，追根溯源都是LZ77算法的衍生。看名字就知道它是Lempel和Ziv在1977年发明的算法。它是基于字典编码理论的一种实现，细分静态词典和动态词典，静态编码指编码器事先准备好词典，如果文本中的词不在词典中，则不进行压缩；动态词典则基于对文本的统计，LZ77是动态词典的开创者，同时也是当今各种泛用形文本压缩算法的原型。

LZ77算法有滑动窗口和前向缓冲（Lookahead Buffer）两个概念，先读入的会放入滑动窗口，并作为动态词典的样本，同时对后续的文本尝试匹配，匹配成功则进行替换，不成功则进入滑动窗口用于后续替换，如此迭代直到整个文本被处理完。后来的研究者基于LZ77的理念，在实现细节上做了很多优化，也形成了如今种类繁多的改进算法。

基于LZ77的理念，就比较好理解为什么许多软件会有多个最快压缩和最大压缩的级别可选，核心就是通过控制滑动窗口的大小和匹配的阈值来调节计算过程。比如大数据领域的Snappy算法就是控制匹配长度的下限为4来提升压缩速度，另外它还设置了每个压缩块长度32k，块之间互相独立，因此只用2个字节就能表示块中的偏移，滑动窗口每次移动4字节而不是LZ77的1字节，种种优化措施下来，Snappy的压缩速度非常可观。另一种用于互联网的Brotli算法，加入预定义字典的方式（有点动静结合的意思），提升压缩率。

gzip采用的也是LZ77的变种，压缩率可以在0-9之间选择，0不压缩，9最高。实测选9并base64，在原始文本约1K时，压缩效果正好被base64抵销，当文本达到27K时，转换后能达到58%。由于我大量的文本都在1~3K，整体做下来压缩率不足5%。之所以效果不佳，我猜还是出在footer太重以及文本本身太短。再考虑到本身web服务器就会对文件采用zip传输，最终放弃了压缩的想法。

## 声音和图像

由于人类自身感官的限制，声音和图像在压缩过程中是允许丢失一定精度（其实在数字化采样的时候，原始精度就已经丢失了），就有了无损与有损的划分。加之采样又有整数采样和浮点采样，所以音视频的压缩算法比文本要丰富得多。

以音频采样为例，无损领域有两个非常有名的编码格式APE和FLAC，后者就只使用整数采样，又因为音频播放器往往都会用DSP解码，只使用整形对DSP来说无疑极大降低了硬件的要求，这也是FLAC现在比APE更主流的一个小因素。

## zip文件头

zip作为压缩格式虽然不是压缩比最高，但由于其诞生年代早没有专利保护，受到了操作系统和各种开源社区的广泛支持。有次遇到被7z压缩的文件用zip解压，报错PK版本过低，原来是magichead后面会有两个字节表示所需要解压软件的最低版本。而PK正是zip的发明者Phil Katz的首字母。