# UDP广播多播和IPv6记要

## 广播与多播

UDP的socket才有的特性，其中广播是socket级的特性，需要setsockopt时指定SO_BROADCAST选项，而多播是IP级的，比如加入一个多播组，用的是`IP_ADD_MEMBERSHIP`和`IP_DROP_MEMBERSHIP`。

为什么一个是IP级，另一个是socket级，大概是因为广播包一定会通过IP层，直到UDP层才会做处理，因此用SO前缀；而多播地址是D类网段，加入多播组时，网卡会知道，会在网卡级收到消息时就过滤，连驱动层都不能到，更别说UDP层了，所以用了IP为前缀的选项。

广播时socket如果要接收，要先将自己绑定到INADDR_ANY和广播的端口，一旦感知到消息再通过recvfrom从`INADDR_BROADCAST`的相同端口接受数据。发送则不需要绑定，直接sendto到`INADDR_BROADCAST`的约定端口就可以了。广播的接收与发送因为地址只有一个`IPADDR_BROADCAST`，所以只能靠端口区分，接收端也必须作一次bind。

多播是与地址相关，只要bind地址就可以了，和端口关系不大，之所以现在的代码都要绑定地址和端口，是因为历史上Solaris对多播要求必须做端口的绑定，所以后来的代码出于跨平台的考虑，都加入了端口绑定。

加入多播组有三个选择，IP_ADD_MEMBERSHIP，`IPV6_JOIN_GROUP`和`MCAST_JOIN_GROUP`。前两个是与IP协议版本相关，不能混用，而MCAST是协议无关，使用的地址结构体也要大得多，至于功能是一样的。

## IPv6

源和目的地址从32位扩大到128位，分为高低两个64位，高位表示网络类型(单播/组播/任播)、子网标识，低64位则表示网卡地址，可以由MAC地址计算。加上其它的控制标志，IPv6的报头从20字节扩大到40字节。

MAC地址48位同样分为上下两个24位，高24位是厂商标识，低24位则是网卡标识。从最高位开始数的第7、8位有特殊的含义，第7位如果是0表示IEEE分配，如果是1则表示本地分配。没见过是1的，第8位是0表示单播MAC，1表示组播MAC。当发送广播包时，会在发送前把MAC地址的第8位改成1，静态情况下通过ifconfig无法看出来，只有运行期抓包才能发现。由于第7和8都是0，所以正常12数字的MAC地址的第2个数字一定0bXX00即4的倍数。

IPv6的socket默认可以接收IPv4的连接请求，除非显示打开`IPV6_V6ONLY`选项。所以如果用netstat看到只监听v6端口，不妨先尝试v4的连接。