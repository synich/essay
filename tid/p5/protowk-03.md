# 03 几个具体的协议思考

## 变倍与聚焦 at 16.10

监控行业的相机有枪式和球式两种，还有种半球但实质上和枪式一样，只是安装方式不同。两种相机因为外形和机械结构的不同，使用场景也有很大差异。比如枪式相机主要安装在室内，而球式相机装在室外的较多。这种场景的不同，导致对图像的调校也不一样，典型如白平衡，两者的侧重点就很不一样。

这里从变倍和聚焦出发，谈谈两者的不同。先说说两者的异同：

* 变倍的主要作用是调节透镜的物距，进而影响成像的大小，变倍主要有光学变倍和电子变倍。
* 聚焦则是使物体成像于焦点上，能看到清晰锐利的图像。

从光学镜片的物理特性来说，单个镜头的曲率固定，焦距也固定，无法实现变倍。要变倍必须有多片镜头组，通过调节互相之间的位置，得到一个整体的等效焦距，这个焦距才能变化，焦距变化后就能达到变倍效果(准确的说是视角的变化)。而调焦是由于焦平面没有落在sensor上，整体移动镜头组，在此过程中焦距不会变。

为什么很多人会说分不清楚两者呢，因为在使用的过程中，变倍和聚焦在直观上都有一个物体由模糊变清晰的过程，所以会觉得两者很相似。但仔细区分的话会发现，变倍会引起物体大小的变化，而聚焦只会变清晰，但并不会改变成像的大小。而且更进一步说，变倍并不会使物体自动地变清晰，往往是镜头实现了自动聚焦这一动作。

变倍尤其是光学变倍，都会调整透镜和CCD或CMOS的距离，因此都需要配备电机，或者更高级的会使用步进电机，这就必然导致成本上升。因而低价位的枪式相机大多不具备变倍功能，因为没有变倍，焦距也能在出厂前就调节完成，所以既没有变倍，也没有调焦功能。

而球式相机由于自带云台，能够各种方向的旋转，在旋转的过程中很自然的有了变倍的需求，因此球式相机在行业里又称为PTZ，P和T是Pan(水平)和Tile(垂直)的意思，指的是云台底座的运动方向，而Z则是Zoom，即相机镜头的变倍。当然带云台的相机也可以没有变倍，两者并不强关联。由于球式相机大都具备变倍功能，在日常使用的过程中也经常要调节倍率进行物体的跟踪，往往要配备比较强大的聚焦算法，否则跟踪物体就会发虚模糊，用户是不能接受的。因此对球式相机来说，变倍是其基本功能点，而自动聚焦则是必备条件，但是又由于球式相机经常处于运动状态，对于聚焦只要能达到人眼可见的清晰程度，就能满足用户的使用了。

枪式相机，如果具备变倍功能，通常也会同时提供聚焦的调节功能。当用户购买了变倍相机，并在安装时根据场景选择好倍率，就会仔细地调节聚焦，力求画面清晰锐利，因为枪式相机的视野比较固定，一旦安装好，变倍就固定下来不会轻易改变，因此对聚焦就会有更多微调节的需求。

因此在枪式相机上，能看到单独的变倍和聚焦页面，而球式相机则往往只有变倍的按钮可以使用。

上文说到聚焦的目的是使物体变清晰，那么这个清晰要如何定义呢？如果是手动聚焦，一切依赖肉眼那就全由人来完成，但是往往相机都能自动地调整好焦距，这又是怎么做到的？这就涉及图像处理的算法了：比如在画面中有一个人，那么这个人的轮廓和画面的背景交界处，一定会出现较大的差距(当然如果你非要穿着黑衣在黑夜里，就没得谈了)。那么我们就可以通过计算图像中这些亮度差距较大的地方，来勾勒出轮廓，并通过调节画面，找出亮度差最大的一个场景，这时从理论上说，就是焦距最准确的位置。这个找最大差的原理则类似数学中的求导，当然具体细节复杂得多，只是一个约略的近似。除了这种自动聚焦的方式，还有一种辅助聚焦，在手动调节焦距时，由相机反馈一个当前聚焦峰值，一边手动调焦一边观察聚焦峰值，当这个峰值达到最大的一刻，就找到了焦点。有种把自动聚焦的内部参数，开放给手动调节的感觉。

所以虽然都是变倍和聚焦，由于相机的使用方式不同，这两个功能的呈现和侧重也会有所差异。概括地说就是

* 枪式相机更注重聚焦，达到更好的画质
* 球式相机更注重变倍，达到运动过程中更好的观看体验

## 礼让行人和车流量协议反思 at 17.06

礼让行人协议的问题是，在说明时忽略了背景介绍。原文是这样的

    Direction : ["Left", "Right"]; Left表示向左，Right表示向右，数组为空表示表示不关心方向，即行人即使不动也表示违规。

这句注释的后半句还好，但前半句就很可笑了，谁不知道Left表示左呢。因为左右是相对的概念，如果不说明坐标系是没有意义的。我初以为是俯视图，但怎么也想不出来，另外同事认为是面对红绿灯的视角，直到问了做过这块业务的开发才知道是以相机预览画面视角，车为上下行故人为左右行。因此把视角补上才完整，另外方向已经解释，但单方向如左表示违规的情况没有给出示例，需要说明比如左车道只有左行，即和车方向靠近时才表示违规，这样的解释才是个好的说明。

再说车流量协议，原稿描述很简单，分别显示机动车/非机动车流量。初看并没有问题，但车流量有很多分类，除了机/非方式，还有按左转/右转/直行分类，也可以按轿车/卡车分类。所以在显示之前要先定下分类模式，然后展示。另外机和非的定义其实也不够确定，比如按车长定义，以4/6/9/12米长度为界把车分为5类，这样的定义相对更严谨一些。

## 人脸查询协议的理解 at 18.01

一个人脸查询协议反复看了大半年，每次看都有新的体会，直到现在我也不确信是不是完整理解它。

人脸比对涉及两种对像，历史库和注册库，保存的虽然都是人，但历史库是对人一瞬间的描述，注册库则是对人精确描述，两者差异极大。比如年龄，在历史库是年龄但到了注册库却变成了生日，同一件事要用两个角度去解释。

既然两种不同性质的库，查询条件就应该不一样，合在一个接口已经容易引起误解，偏偏最重要的，从哪个库查询字段却放在中间很不起眼的位置，人的理解思维总是头尾相对容易重视，中间如果太多往往会不耐烦地跳过，偏偏这个协议的协议字段有二十多个。

我的调整是，首先按历史库和注册库拆分成两条协议，并对查询条件分类。比如上面提到的年龄，另外像历史库用到的眼镜和注册库用到的家族住址。

除了指定信息查找外，人脸还有种好玩的查询叫以图搜图。给一张照片，会返回若干张和这个照片最像的候选人像。如果有图片，图片本身就表示了一切属性，此时检索条件又不一样，因此又再细分为信息查询和以图搜图。而以图搜图的条件也多是一些模糊性的条件，比如按人脸哪个区域比对（选眼睛还是鼻子）。

经过这样分解拆分成4条协议，再结合对业务理解，可读性才勉强到可用的程度。

再说说库相似度。有需求要求修改人脸库时可以修改相似度，最初我也觉得可以，但经人提醒意识到，为什么会有相似度，是因为人脸识别算法的不准确性需要阈值，但既然是阈值一定要结合当时的环境一起考虑，不应一概而论。环境就是视频通道，经过讲解让需求方接受了这个用法。看一个概念要理解其背后代表的含义和适用场景，否则就容易用偏。

## 查询协议与资源回收 at 18.02

遇到一个查询业务资源未回收的问题。查询的返回数量不确定，因此会有同步和异步的方式考虑有两种返回形式。如果是异步，在查询前传入一个回调函数，所有的查询结果逐步回调给调用方。如果同步方式，由查询方每次给出一个偏移量和一次查询的数量，逐步地查完。这次的问题就出在同步方式上。

由于是个连续的过程，第一次查询会返回一个句柄号，接下来的查询每次都从这个句柄获取，查询完成后释放该句柄。暂不考虑客户端恶意查询而不释放的问题，当网络断开时，也会存在句柄未关闭从而导致资源泄露问题。原因在于定义查询接口时，和其它的业务定义在同一个类里，而所有的类要服务化，都以单件的形式存在，当网络断开时即使协议库调用了析构函数，实现侧无法做到查询句柄的回收。

服务化和单件不是错，但对这类存在资源分配的业务，把接口都定义在单件中，就使得单件拥有了两种不同生命周期的业务，增加了维护的复杂度，这种情况要避免。

## 行人卡口事件的思考 at 18.03

收到智能交通产品线增加行人卡口的需求，此前协议中已经有名为HumanTrait的事件，表示视频画面中出现了人。第一感觉就是行人卡口记录的也是人的出现这一事实，和HumanTrait有没有差异？

思考的角度

能否复用就要仔细地比较两者的异同。先分析HumanTrait事件，当视频画面中出现了多个人，会以每个人为单位，进行一次这个人的事件上报，并尽可能地带上脸部照片和一些分析信息。而行人卡口要求记录一个人不同时间的画面，比如走过斑马线前后的画面。虽然描述的都是人，但是HumanTrait是从同一个时间进行切入，描述在这个特定时间点某个空间内人的状态；而行人卡口描述的是同一个人，在不同时间点构造的一个序列。*HumanTrait是多人合照，行人卡口是个人短视频*。

反思与推广

做协议经常会遇到到底能不能，要不要复用的问题。如果要复用，要看这个复用协议描述的粒度。但是在定义第一版协议时，因为没有比较，描述往往不精确，会隐含了很多外部信息，直到遇到新需求，才会发现原来还可以从另一个维度看。

像上面提到的过人事件为例，第一次看到这个需求时，的确没想到可以从时间序列去记录一个人。其实第一次分析不完整问题也不大，只要后面遇到新需求时，回过头来比较、细化已经定义好的协议也是来得及的。

另一个悖论是倘若粒度真的太小，非常地场景特化，能被复用的可能性自然就少了。

## 一些讨论纪要(17年6月初)

1. 协议的本质是什么，好的衡量标准(金线)是什么？

    协议是被网络化的接口，接口的本质是契约。即在什么样的规定前提下，通过什么样给定的输入，最终达成怎样的输出。衡量标准就是契约的定义，越详细越无歧义越好。至于扩展性的权重，是第二位甚至更靠后，大不了重新订一份新的契约就好了。

2. 公司协议有4千多条，粒度是什么或者说应该依据什么来制定协议？(此处是两个原始问题)

    有4千多条，就说明有4千多个应用场景，分别有不同的输入，有不同的期望输出。考虑到公司重OEM属性，光IPC一年软件版本能达到1万多个，4千并不多。至于粒度，对超过90%的定制协议，满足定制客户的使用场景就是好的协议。如果一定要说粒度，两件事，如果以普通消费者能够区分的差异度来区分协议。但也不要把从软件上可以归并的行为硬生生归在一起。我想到微信的例子，把小视频和拍照合并到一起后，我的母亲就再也不会用小视频了。(因为那个按键短按是拍照，长按是视频，母亲不会用长按这种操作方法)

3. 协议要包含哪些元素？

    同问题1，界定什么场景下用，输入和输出，这些要素是第一性的。至于其它request-ID，session-ID，就好比是合同中的签名，如果再有时间戳，相当于合同的有效期，就更好了。

4. RPC要定义哪些方法，如何让调用者更简单？比如做到RESTful风格。

    简单的定义要从理解角度看，如果用户懂业务背景，或者需求就是用户定制的，那么和定制需求完全契合的协议，就是最简单的。说实话RESTful风格未必就是简单，把一切都认为是资源的行为，然后基于资源的操作，这种思想适用于互联网，或者反过来说，正是基于互联网的基础设施，提出了RESTful。但不同的领域，未必都要按RESTful方式设计。让使用者最自然的使用方式，就是简单。这方面有很多理论，最少知识/最少惊奇原则。
