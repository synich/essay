# 网络层的交换与路由

## 网段定义

对于私网地址的规范，在RFC 1918 - Address Allocation for Private Internets里有完整的规范定义。其中A类，B类，C类网段各取了一部分：

* 10.0.0.0/8 (255.0.0.0)
* 172.16.0.0/12 (255.240.0.0)
* 192.168.0.0/16 (255.255.0.0)

192的私有网段只能放下255^2即6万多台主机，家庭当然够用，但大企业可能就不够。所以大公司内网会用10或172网段。

可能最早的路由是用192.168.0.1，从最小的0开始合理，后来随着小区有了网络，为了避免和外级网络冲突，用了192.168.1.1，好比现在的无线网络用192.168.2.1，原理是类似的。

最后一位不能用0。原理大概是这样，0和255都是广播地址，**关于0到底是广播还是主机号，此处存疑，但不用肯定没错**。0不能被主机使用，255可以。但如果用255会被用作广播的收端，尽量避免。有些特殊会用254，所以也有路由器用253地址。

倒数第二位用0虽然理论上很正确，在早期的路由器中，0段子网在没有子网掩码的情况下会与它的网络号相同而产生路由上的混乱，古老的路由协议RIP在路由时就不考虑子网掩码的问题，所以在cisco的设备上才有 ip subnet-zero这个命令来打开对 0段子网的支持。可能出于规避目的，用192.168.1.1。当然现代的路由器应该不需要考虑这些问题了。

## 交换和路由的区别

简单的说，同一个网段内叫交换（二层），不同网段之间叫路由（三层）。现实中也有三层交换，属于特例。

早于IP网络的电话交换机，可以理解为一层交换。对电话来说独占一条物理电线，不存在IP分包的概念，直接对物理介质做交换控制，所以是一层。

路由路径在二层和三层的路径是不同的。二层用ARP协议，从IP反查MAC直接物理层就找过去了。三层就全是IP寻路，通过网关出去，并由网关往后一级的网关传递，最终找到目的地。

有两个常被忽略的属性，dev和scope。dev相对于对gateway的一个更小的约束。同样起到约束作用的还有scope。Scope是一个更小程度的约束，指明了该路由在什么场景下才有效。也是用于约束目的地址的。例如不指定网关的二层路由，通常对应的scope类型是scope link。scope link的意义就是说明在同一个二层。这个意义与网关不指定的效果是呼应的。

四种scope

1. global是在任何的场景下都有效，link是在链路上才有效，这个链路是指同一个端口，也就是说接收和发送都是走的同一个端口的时候，这条路由才会生效（也就是说在同一个二层）。Global则可以转发，例如从一个端口收到的包，可以查询global的路由条目，如果目的地址在另外一个网卡，那么该路由条目可以匹配转发的要求，进行路由转发。
2. link的scope路由条目是不会转发任何匹配的数据包到其他的硬件网口的。
3. host表示这是一条本地路由，典型的是回环端口，loopback设备使用这种路由条目，该路由条目比link类型的还要严格，约定了都是本机内部的转发，不可能转发到外部。
4. site是ipv6专用的路由scope。

再以自建私有云来举例，如果在一个机房，各主机之间走交换就够了。如果有两个机房，要做到互相访问就得走路由，肯定不能再用云上的私有IP，为了实现跨路由转发，我知道有两种方案：

1. 将消息封装成`IPIP`协议，路由看到的是外网IP，转发进机房后，再由内核解开头，用内网IP转发。好处是通用，但由于是软件解包，性能开销很大，产品化的风险很高
2. 使用VxLan方式传输消息，由于大部分网卡硬件支持VxLan协议，性能好很多

## route命令

Windows和Linux的参数不完全一样，网上找文章时要注意。route命令除了添加了删除，还能屏蔽某种路由路径。route命令除了支持inet协议，还能支持ax25、ipx、netrom等数种二层协议，不过由于/proc/net/下没有对应的文件，所以没有使用。

## 路由协议和preference

到某主机有多条路可选，会挑选优先级高的。比较方式先匹配掩码长度，再比较管理距离(比如metric)。掩码长的高于掩码短的，所以3种路由顺序如下

1. 主机路由，直接指明某台主机，/etc/hosts
2. 网络路由，指明某类网络怎么走
3. 默认路由，也叫默认网关，一般是目标地址为0.0.0.0的那条

路由器往往支持多路由协议，这就有一个多种路由的选择和配合问题。为了解决这个问题，在路由的参数中引入了优先级（preference）的概念。各路由协议一般来说都定一个固定的preference值，preference值越小，协议对应的路由的优先级越高。以下是业务标准的路由协议：

* 直接路由  0
* OSPF路由  10
* IS-IS的level 1的路由  15
* IS-IS的level 2的路由  18
* RIP路由（Berkeley）  100
* BGP路由 170
* EGP路由（已被BGP淘汰） 200

RIP是最简单的协议，只告诉近邻，距离目标有几跳，且当目标之间距离变长后，并不会更新，因此网络收敛非常慢。RIP协议规定跳数上限是16，因此17可以认为是目标不可达。

OSPF/ISIS比RIP高明的地方，RIP只知道邻居选择告诉自己的消息。OSPF/ISIS邻居不会隐瞒任何消息，会毫不保留地将消息传递给整个参与OSPF/ISIS网络里的任何一台路由器。因为信息同步是OSPF/ISIS能够正常工作的前提。如果不同步，OSPF/ISIS有网络环路的可能。OSPF内划分一个或多个Area，规模小的话只要一个Area0就行。由于OSPF/ISIS分享的信息过多，只适合运行在一个AS（Autonomous system 自治系统）内部，自治系统可以是一个公司，或一个校园网，也可以是一家运营商。每个AS会有个独立编号，公安网内部号段6xxxx和7xxxx。

RIP、OSFP都属于内网路由，但规模不能太大，如果是非常大的AS，或者AS之间，就要引入BGP协议。

BGP路由最复杂，主要用作不同AS间的边界网关，也是互联网惟一的协议。可以配置路由的颗粒度。颗粒度是由路由前缀的长短决定的，比如17.0.0.0/8的颗粒度很粗，17.1.0.0/16就会稍细，当然17.1.1.0/24颗粒度会更细。但是颗粒度太细，又会造成路由表的臃肿不堪。当前对颗粒度的要求是，路由前缀的长度，要≤21。

BGP是唯一使用TCP作为传输层的路由协议（端口179），其他的路由协议可能都还到不了传输层。TCP连接的窗口是65K字节，也就是说TCP连接允许在没有确认包的情况下，连续发送65K的数据。而其他的路由协议，例如EIGRP和OSPF的窗口只有一个数据包，也就是说前一个数据包收到确认包之后，才会发送下一个数据包。当网络规模巨大时，需要传输的数据也相应变大，这样效率是非常低的。这也是它们不适合大规模网络的原因。而正是由于TCP可以可靠的传输大量数据，使得BGP适合大规模网络环境。

BGP不同算法对收敛速度影响不同，比较快的有BFD，FRR算法。

## 路由metric的含义

需要区别的是路由开销（metric）和路由优先级（preference）这两个概念。metric是针对同一种路由协议而言，对不同的协议，由于代表的含义不同，比较不同协议的metric是无意义的，所以要在两条不同协议的同信宿路由中作出选择，只能比较路由的优先级。相反，preference是针对不同协议而言，同协议的路由的优先级是一般情况下一样的，metric这时是在两条同信宿路由中作出选择的标准。