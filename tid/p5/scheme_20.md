# 20 使用fennel体会

我不是lisp高手，也不懂lambda演算等高深的理论，但很喜欢lisp的S-Exp语法，学习的时候就觉得写代码很舒服，很有结构性。

听说有很多lisp大牛喷fennel不是个完整的lisp，但对一个经常用lua写小脚本但又偏好lisp语法的我来说，fennel是lua生态上很好的助益（话说lua本来也没什么生态）。

我很早就阅读过大名鼎鼎的SICP，也很想在日常的工作中用lisp系的语言，虽然有很多scheme的实现，但每种API都不一样，使用car/cdr操作数据结构也实在难受。我只是想用一种简单直观的脚本快速完成工作，顺便如果写起来舒服就最好了。lua是我第一门接触的脚本语言，也读过源码，这么多年也积累了一些基于lua的增强库，所以平时经常用lua写些脚本（近年来用Python也多了起来，架不住库多啊），但lua在语法上的缺陷时常令我恼火，当我发现fennel后，它的设计哲学瞬间打动了我，而且fennel编译出的lua脚本使我能清楚地知道背后的转换规则。当我尝试用fennel写小脚本后，代码行数大约减少了1/3，也更不容易出错。因为S-Exp的语法非常适合修改，可以快速的选中某个层级的表达式并进行层次上的调整，写脚本经常要调整逻辑或加条件，编辑起来很顺手。

1. set赋值只能作用在var声明的变量，let/local都是不可变的
2. fn和let隐式支持do，写副作用代码没有负担
3. 没有car/cdr，用.操作表元素
4. :开头是symbol，本质和字符串一样
5. case where 组合了条件和解构两种用法，很简洁（1.3新增语法，改进了match语法的一些小缺陷）
6. with-open 省心好用
7. `(:` 和 `{:` 特殊语法初看有点难理解，但细想又觉得很自然

作为对比，我也简单看过基于Python的lisp方言Hy，最近两年一直没有更新，而且Hy编译后的Python代码还依赖Hy库，发布也有问题。而fennel编译后就是纯粹的lua，而且作者的更新非常勤快，于我而言fennel的质量和可信赖程度也更高。

## 宏

fn和macro是一体两面，fn被import-macros导入时就变成了macro，说明这两者只是所处阶段不同，其它完全一样

宏的quote部分，如果是引入新的局部变量，要在变量末尾加#。如下 `(let [,name xx val# (do )])`
