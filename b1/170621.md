云升级项目的反思
====
这个项目大概是我在大华经历最失败的项目了，因为不确定最初的需求到底是什么，我自己的理解应该只是客户无法下载升级包，如果是这样提供工具可以
下载升级，而不是执着于必须由设备主动从云下载。

嵌入式设备的升级包包含的分区非常多，比如一个典型的NVR升级包，去掉签名包还有6个分区，分别是uBoot、kernel、rootfs、web、custom、logo。前三个是执行所不可少的，web一般来说也是必须的，custom和logo则和公司的商业模式有关，因为有些大的OEM商不会修改功能，只要把logo换掉，最多把web界面的配色换了就可以，所以这两个分区独立是有价值的，custom分区则给一些小的定制功能使用，通过配置来打开/关闭某些功能。uboot和kernel不需多说，rootfs包括了执行程序，和busybox等接触最多的程序。

正是因为多个分区具有独立升级的需求，导致需求分散极难实现。

因为云升级项目考虑到法务上的风险(不明白为什么会有这样的顾虑？)，在初始化的阶段又加入一个云升级自动检测的开关，最初在做初始化需求的时候并没有考虑会有多个步骤，认为只要账号初始化整个过程就完成了。结果多了一个步骤后，导致原来一个原子化的操作有了状态。一旦有了状态，就必然要考虑中间的异常情况，另外还涉及到多个库间的兼容性问题，变得非常难处理。

经过一个星期的理解，突然意识到云升级自动检测、云接入并不是必须的，和账号初始化的重要性不同，云升级只是个可选项，并不影响设备的使用，因此就不应该和初始化使用同一个状态机。把云接入总结为开机向导的概念，和初始化分离开。所以协议最重视的，就是概念或定义一定要清晰，市场或需求包会统称为初始化，但在程序实施时必须要把不同的概念分开处理。

考虑到云升级可能会没有网络(神设定啊！)又在NVR上增加一层代理设计。代理本身是个专门的领域也有专门的SOCK5协议，但由于时间关系显然不可能集成SOCK5的情况下，领导安排手动实现一个代理，且最好两端都能做到无感知。可是显然是不可能的，因为作为代理方，必须要知道下一跳去哪里，或者说请求发必须要知道代理的存在，这个下一跳的存在就不可能作到和直连完全等价，因此一定有一方需要做出区分。但是总有人妄图用一套接口实现两个流程，可惜当时没能把下一跳这个关键点亮出来，花了很多唇舌才说服众人保持方案不变。