# P2P及SIP和xinetd

P2P穿透涉及的协议有STUN/TURN/ICE，STUN是真正的UDP打洞，但只适用于cone NAT的网络环境下(完全、限制、端口限制三种都支持)，因为STUN的核心是子网内的客户端和公网建立连接后，NAT映射后的公网地址要能被另一个客户端使用，只有cone NAT才满足这个条件，symmetric NAT不允许公网端口复用，因此无法即使从公网上获取了NAT后的地址，也不能用来和另一个对端连接。

对symmetric网络，只能使用中继方式，就用到TURN的方式，ICE要解决的问题和TURN类似，但两者的差异还没有完全清楚。

P2P之后两个端就要建立会话，SIP是定义非常严谨的协议，明确地分了4个层级，基础的用ABNF规定了文档用语的格式，然后是传输层，接着是和业务关联最紧密的事务层，事务层之上还有个可选的事务用户(TU)，但这一层并不是必须的，比如无状态的proxy就没有TU一说。

xinetd类程序
--
知道xinetd这玩意属于偶然，本想尝试着在linux上跑cvs的server端，然而还是失败了。所有的服务端程序都需要监听端口，比如httpd就自己监听80，但是如果有大量非高频程序，要监听各式各样的端口，全数都启动显然是浪费资源，super server daemon也就是xinetd就是解决这类问题。这个程序的前身是inetd，不过现在都切换到xinetd了。
它的功能是配合/etc/service配置项，监听各种各样的端口，然后把端口请求转发给相应的程序。比如在/etc/xinetd.d/目录下配置2401端口由cvs监听，平时cvs不会启动只有2401端口来请求时就唤醒cvs来处理。很多本身不带网络服务的程序，通过xinetd就具备了通信功能，有点CGI的味道。

从功能上可以看出xinetd属于优化类程序，并不是默认自带程序，Alpine linux甚至都没有包。在Cent7下通过yum install xinetd安装，也可以通过下载包手动安装，依赖很少。xinetd程序也很小，x64版本不到200K。安装后还需要通过service xinetd start启动，这样才真正开始监听。

用xined监听telnet遇到问题，系统默认telnet只能监听23端口，但是这要求有root权限，这种情况下要先在service增加一个伪telnet服务，让这个服务监听新端口，然后配置这个伪服务，最终导给telnet监听。

busybox有类似的程序tcpsvd，配套telnetd和ftpd一起使用。