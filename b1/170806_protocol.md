# 区块链的运行机制

区域链本质上是一种由交易驱动的，由共识确认并跃迁的状态机。区块链由区块以单向链表方式连接，并利用哈希的特性保证了数据的不可篡改性。

交易可以是BTC的转账支付，也可以是ETH的智能合约。每个人都可以发起交易(相当于向区块链提交一个合并请求)，这笔交易会保存在矿工节点的内存中(普通节点只传播，但不保存)，当这笔交易没有记入主链前，就不具备合法性。要合入主链需要矿工的确认，由于每个块的容量有限，矿工只会选择手续费高的一些交易合入区块。如果块容量上限太小，或出现爆发性的交易数量，就一定会有交易驻留在矿工的内存(常说的网络堵塞了)，才有BTC的扩容争议。一旦交易被矿工commit，且最终被成功地seal(以上两个词取自ETH的日志)。这条交易就具备了永久的合法性(严格地说还要再加上若干次确认，否则有可能出现在分支上，最终还是被更长的链超越而视作无效)。

众多矿工同时竞争向主链的提交，依赖共识算法来决定哪个矿工取得这一轮的权利。方式有很多，如PoW或PoS等。PoW算法达成共识非常消耗成本，因此对完成条件的个体会有激励，这个激励的形式就是增发的数字货币。

Bitcoin交易有Coinbase、P2PKH、P2SH几种（隔离见证后，又增加了P2WPKH和P2WSH）。
早期的交易（高度62061以下）的交易数都是1，这些交易都是coinbase交易，输入没有签名，长度也比较短，典型长度0.215K，sequence通常是0xFFFFFFFF。P2PKH的`tx_in`脚本比较长了，包含签名和公钥，71(签名)\+65(公钥)\+1\+1=138(两个都分别是长度占位)。但是从密码学角度看，有了签名(即R和S)，只要再配上个`rec_id`(范围0-3)是可以反推出公钥的，如果采用这种方式能极大地减少输入脚本长度。
P2PKH交易的`tx_out`，脚本长度25(用1字节表示)，脚本中5字节是操作符，20字节是HASH160的结果，加上8字节的金额总共是34Bytes。

以太坊来目前也是PoW共识机制，它的挖矿算法称为Ethash，这是个比较高层的概念，每个Ethash持有GenericFarm，这个Farm下再持有多个miner，从这个结构看，应该是受了farm和miner的关系就像矿池分解任务给节点的关系。最终的验证通过farm来完成。验证的术语是seal，cppeth自带的seal只有CPU，也许要用上GPU挖矿要用另外的程序吧。seal的封印对象是BlockHead，另外BlockChain对象的作用还没有明白。

以太坊Trie的设计，对轻客户端友好，每个区块头的三个指针代表了三个核心的树：状态、交易、收据。

交易树比较简单，收据是一个RLP编码的数据结构，除了索引变得更加简单，logbloom的使用也让轻客户端使用起来非常方便。

区块头的设计和轻客户端是密切相关的。绝大多数节点并不需要完全同步，但要求访问数据的便利性。

区块内的主要数据结构是MPT，这里面稀疏区域用KV节点。在状态和账户的树里，diverge nodes 深度为64，使用sha3(k)作为key，非常难以DOS攻击。

目前整个状态的访问查询可以变得更快，全节点的全同步也可以变得很快。因为紫皮书带来了新的方向，压缩算法或是uncle区块实现等，紫皮书引入了POS机制，更友好的轻客户端同步实现，计分和测了实现， 分片以及跨分片通信等。

作为公开链的区块链，必然需要密码学为依托，比特币选用了非对称算法中的椭圆曲线SECP256K1，经历了时间的考验被证明是安全可靠的，以太坊和BitShares也沿用了相同的椭圆曲线。

以上是相同的部分，当然也有些不同的部分，不过这些不同只是在使用链的方式不同，不影响区块链的特性。

Bitcoin中只有一笔笔的交易，这些交易会存入一个地址，但并没有帐号。可以想象成有很多张支票，每张支票都有一个谜题，谁能解开这个谜题谁就能使用这张支票，如果一个人说他有很多比特币，或者他有一张大额支票，或者他有一堆小额支票。而以太和Bitshares是有帐号概念的。又比如链的生长速度差别就更大了，Bitcoin基本固定10分钟，以太则15秒，但是因为依赖PoW，并不是严格遵循这个周期，而Bitshares用的DPoS机制，能严格保证3秒出一个块(其实是1～30秒范围内可设置，取决于committee的投票结果)。

按老董的讲解，至少符合三个条件的区块链的项目才有可能是好项目：

1. 必须是在线上建立信任，并基于此信任生发出的项目
2. 逻辑必须是清晰明确且简单的，一方面区块链的计算能力偏弱，另外从技术上写出安全的智能合约极难，为避免风险，也应用用简单的方式
3. 使用区域链所带来的收益要高于成本(任何商业项目都适用)