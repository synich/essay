PNG格式的启发
====
都说PNG格式是二进制格式中的优秀范例，文档也写得非常好。这周断断续续看了RFC2083，常有拍案之处。

PNG的总体格式是8字节的格式头和一系列的chunk构成。

先说8字节头，8字节分别是137 80 78 71 13 10 26 10。第一字节特意用了一个非ASCII字符，防止编辑器将PNG文件误认为是文本文件，同时可以检测程序是否过滤了最高位(似乎说的是邮件处理程序？)。Lua编译出的二进制文件也用了类似的思路，不过那里用还是ASCII的不可打印字符027。

头部之后就是一连串的Chunk。Chunk也有个固定格式，4字节的长度+4字节的类型+数据+CRC32。为什么把长度放在类型前面？因为CRC是流式计算的，也许一开始并不知道最终的长度，所以如果把类型和长度互换，可能会造成CRC的计算困难。而且因为最开始已经有文件头，先放长度也不会造成识别的困难。再说一个小细节，4字长度文档特意标注是一个无符号整数，但范围是2^31-1，即最高位一定是0，原因是考虑到部分编程语言无法表示4字节的无符号整数(至少Java就是这样)。另一个我在工作中遇到有点类似的情况是，可能会有代码一开始错误地按int来实现，当发生对接错误的时候，才意识到要改代码，这时只要限定范围即可，算是保留了一点裕量。

类型部分很有趣，PNG的Chunk类型有两种。一种是大写字母开头，称为Critical，比如IHDR、IEND，再一种是小写字母开头，如sPHY。如果增加了新的Critical类型，客户端无法识别，可以提示用户升级客户端，而不重要的Chunk又可以跳过。当然Critical不是必须要带，只是携带的时候，就相当于需要服务端和客户端做一个版本同步保证。这种策略不需要版本号，也可以达到C/S各自地升级兼容。

PNG的设计目标是用于文件的保存和传输，但其中Chunk的设计策略对交互式的协议也是有借鉴作用的。