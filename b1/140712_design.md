功能重用与接口设计
====
最近在做内部的维基网站，内容是从Word文档解析然后以页面形式呈现。Word可以导出Html，解析也就是针对Html的标签做些过滤并对需要的内容做分类提取。第一期的工作，原有的协议内容绝大多数是一份表格为一个请求/应答，由于表格和章节号都是一一对应关系，即一个标题下也只会有一张张表，解析的时候，就以表结束作为时机，在此时刻插入数据库。这种做法其实是比较死板的，只适合于这一类文档，当出现一个标题下有多张表格，或是除表格外有文字甚至图片时，就难以处理。虽然这类文档都以网页形式呈现，但其中少量的图片，除非对原有解析代码做伤筋动骨的改动，修改起来是十分困难的。

第二期开始的文档，格式就变得多变了。这时我才意识到，只有以章节标题来划分，才是比较通用的做法。并需要对章节内的信息作归类，把标题下的内容按类别加入数据库，这样才更符合日常的整理思维。

虽然第一期作了很多解析功能，函数却不容易被复用，由于接口的注释不明，或是对入参有些隐含的期望，在第二期的工作时，很多函数看起来能用，却忘记了原先的期望，得到的结果自然也就不正确了。这和我虽然计划要做单元测试，却没有真正去实现也有关系。好在函数本身还是可重入的，补上测试用例，单个都可测，测完补上注释就好。回想起来，接口文档里除了描述接口功能，对出入参的描述也是非常重要的。像Python或者Common Lisp都有函数功能描述的专门语法，是个很好的语言设计。

对于表格的解析，一期的文档是按列解析，而二期的文档由于关联性不强，按行比较方便。按最小功能划分，把功能细分成每个单元格才是最通用的设计。这个编译原理中视单元格为词法，将词法按需要的语法规则拼装是一个道理。
