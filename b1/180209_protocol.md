# 查询协议与资源回收

遇到一个查询业务资源未回收的问题。查询的返回数量不确定，因此会有同步和异步的方式考虑有两种返回形式。如果是异步，在查询前传入一个回调函数，所有的查询结果逐步回调给调用方。如果同步方式，由查询方每次给出一个偏移量和一次查询的数量，逐步地查完。这次的问题就出在同步方式上。

由于是个连续的过程，第一次查询会返回一个句柄号，接下来的查询每次都从这个句柄获取，查询完成后释放该句柄。暂不考虑客户端恶意查询而不释放的问题，当网络断开时，也会存在句柄未关闭从而导致资源泄露问题。原因在于定义查询接口时，和其它的业务定义在同一个类里，而所有的类要服务化，都以单件的形式存在，当网络断开时即使协议库调用了析构函数，实现侧无法做到查询句柄的回收。

服务化和单件不是错，但对这类存在资源分配的业务，把接口都定义在单件中，就使得单件拥有了两种不同生命周期的业务，增加了维护的复杂度，这种情况要避免。