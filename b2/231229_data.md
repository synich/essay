# 用离线计算工具实现流式计算的思考

## 离线计算思维的缺陷

传统的处理逻辑是：每日凌晨以后开始对上一个自然日的数据进行归档、计算，并在白天之前完成计算。也许对互联网公司的业务场景，这样是合适且够用的，但到了感知数据场景，存在几个严重的不足

1. 数据必然有延迟，导致每日凌晨以后，上一个自然日的数据往往没有齐备，这时启动计算肯定是不完备的
2. 数据计算部署在甲方且没有运维，一旦某天异常中断，下一次自动触发的计算结果会不正确

用流计算能解决这两个问题吗？理论上可以，但这又牵涉到团队技能栈、计算资源开销、切换等许多问题，加上数据计算(hadoop)和数据使用(ES/MySQL)在不同的存储，而且数量都很大，更新的成本很高。

## 解决办法

计算需要内存，因此一定是有界的。要想解决问题2，每次的计算必须要知道上一次的计算边界，并延续计算，而不是现在这种被trigger_time定义的计算。

外部存储选什么？常见的MySQL、Redis都会增加部署资源，考虑到读写便利性和记录的数量不大，可以使用ZNode来存储上一次计算状态。

为了支持任意时间打断计算并恢复，一天一次触发会导致较多的时间被浪费，但是如果改为6小时，会不会导致白天清空数据并重推，需要考虑。

由于计算模式的变化，出现两种方式：1次1天和1次多天。