网络代理概念与区别
==
模式
--
* 全局模式 所有连接全从指定的端口转发出去，简单却不灵活
* PAC模式，全称代理自动配置，由网景公司在1996年在2.0版本的navigator上开发，是一段JS脚本。根据目的端地址选择不同的出口。在火狐浏览器上与全局模式是二选一关系，谷歌可以装插件单独设置PAC，但应该也是屏蔽全局模式

类型
--
* 正向代理: 比如内网通过网关访问互联网，在客户端侧显式设置
* 反向代理: 在集群最外侧做负载均衡，在服务端侧显式设置

往往公司的正向代理会做行为管理，客户端感知不到它的存在。有几种模式，透明代理/匿名代理和中间人模式。透明代理是做包转发，而中间人模式取自中间人攻击，代理会和客户端先建立https连接，再由代理和目的端建立连接，没有隐秘性。

代理协议
--
连接到代理服务器也需要指定协议

* http 对代理转发端来说最方便，但隐蔽性不够，即使用https也会因为代理多出一条CONNECT从而暴露目的，多用于企业或学校内网
* socks 专为代理设计的协议，定义足够简洁且历史悠久，支持的软件也很多
* shadow_sock 为解决socks加密和隐蔽性不够而开发的新协议，有变体，应用较多
* 各类VPN 这个工作在IP层，比以上的传输层代理更通用

socks应用
--
socks协议非常简单，有4，4a，5共3个版本。socks4只支持TCP，版本5增加了UDP，也成了当今代理界的事实标准。ssh的-D隧道就是在客户端启动的socks5代理。

整个流程包含认证和确定目标两个阶段，最简单不作认证的情况下，两次交互以后的数据就是纯转发了。因为协议是明文且特征明显，很容易被识别出真正的目的地址，要用socks5穿墙是不可能的，往往是用在本地程序和本地加密代理间。

shadowsocks的本地端就以socks5方式接受数据，之后把数据混淆后转给ss服务器，回复的数据最终以socks5方式给到应用程序。

IE浏览器也支持socks5，但要注意不能填http/ftp，只能填写socket那栏，socks5代理才能生效。

实现一个最简单的HTTP代理
--
最简单的代理，得到HTML的主体内容并回复给请求者，以PHP为例，最简单的做法是用curl取得数据。要注意的是对于HTTPS，要关闭验证否则会得不到数据。另一种做法是用`file_get_contents`，在某些环境要配置签发CA的根证书，没有无法获取，且只能得到HTTP的body，header描述信息会丢失。

不管是curl和file函数，获取到的网页主体HTML内容是一致的。但网页的复杂性在于HTML还包含了CSS和JS代码，需要额外下载。如果是绝对地址可能到不可达；相对地址在展开时，浏览器看到的是代理地址，所以会补全成代理的地址，这时显然就不能获取到资源文件了。所以代理的难点，就在于尽可能穷举各种URL的形式，并替换成指向源端的地址。